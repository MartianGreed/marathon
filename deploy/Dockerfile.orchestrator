ARG ALPINE_VERSION=3.19
ARG ZIG_VERSION=0.15.2

FROM alpine:${ALPINE_VERSION} AS builder

ARG ZIG_VERSION

RUN apk add --no-cache curl xz tar

RUN curl -L https://ziglang.org/download/${ZIG_VERSION}/zig-x86_64-linux-${ZIG_VERSION}.tar.xz | tar -xJ -C /opt && \
  ln -s /opt/zig-x86_64-linux-${ZIG_VERSION}/zig /usr/local/bin/zig

WORKDIR /build

COPY build.zig ./
COPY common/ common/
COPY orchestrator/ orchestrator/
COPY proto/ proto/

RUN zig build -Doptimize=ReleaseFast

FROM alpine:${ALPINE_VERSION}

LABEL org.opencontainers.image.title="Marathon Orchestrator" \
  org.opencontainers.image.description="Distributed Claude Code task orchestrator" \
  org.opencontainers.image.source="https://github.com/MartianGreed/marathon" \
  org.opencontainers.image.licenses="Apache-2.0"

RUN apk add --no-cache ca-certificates busybox-extras

WORKDIR /app

COPY --from=builder /build/zig-out/bin/marathon-orchestrator /usr/local/bin/

EXPOSE 8080 9090

HEALTHCHECK --interval=30s --timeout=5s --start-period=10s --retries=3 \
  CMD nc -z localhost 8080 || exit 1

USER nobody

ENTRYPOINT ["/usr/local/bin/marathon-orchestrator"]
