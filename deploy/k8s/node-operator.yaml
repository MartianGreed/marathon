apiVersion: v1
kind: ConfigMap
metadata:
  name: node-operator-config
  namespace: marathon
data:
  MARATHON_LISTEN_ADDRESS: "0.0.0.0"
  MARATHON_LISTEN_PORT: "8081"
  MARATHON_ORCHESTRATOR_ADDRESS: "orchestrator"
  MARATHON_ORCHESTRATOR_PORT: "8080"
  MARATHON_TOTAL_VM_SLOTS: "10"
  MARATHON_WARM_POOL_TARGET: "5"
  MARATHON_SNAPSHOT_PATH: "/var/lib/marathon/snapshots"
  MARATHON_FIRECRACKER_BIN: "/usr/bin/firecracker"
---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: node-operator
  namespace: marathon
  labels:
    app: node-operator
spec:
  selector:
    matchLabels:
      app: node-operator
  template:
    metadata:
      labels:
        app: node-operator
    spec:
      hostPID: true
      hostNetwork: true
      nodeSelector:
        marathon.io/compute-node: "true"
      tolerations:
      - key: "marathon.io/compute-node"
        operator: "Exists"
        effect: "NoSchedule"
      containers:
      - name: node-operator
        image: marathon/node-operator:latest
        securityContext:
          privileged: true
        ports:
        - containerPort: 8081
          name: grpc
        - containerPort: 9091
          name: metrics
        envFrom:
        - configMapRef:
            name: node-operator-config
        env:
        - name: MARATHON_NODE_ID
          valueFrom:
            fieldRef:
              fieldPath: spec.nodeName
        resources:
          requests:
            cpu: "1000m"
            memory: "1Gi"
          limits:
            cpu: "4000m"
            memory: "4Gi"
        volumeMounts:
        - name: dev-kvm
          mountPath: /dev/kvm
        - name: snapshots
          mountPath: /var/lib/marathon/snapshots
        - name: rootfs
          mountPath: /var/lib/marathon/rootfs
        - name: kernel
          mountPath: /var/lib/marathon/kernel
        - name: run
          mountPath: /run/firecracker
        livenessProbe:
          tcpSocket:
            port: 8081
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          tcpSocket:
            port: 8081
          initialDelaySeconds: 10
          periodSeconds: 5
      volumes:
      - name: dev-kvm
        hostPath:
          path: /dev/kvm
          type: CharDevice
      - name: snapshots
        hostPath:
          path: /var/lib/marathon/snapshots
          type: DirectoryOrCreate
      - name: rootfs
        hostPath:
          path: /var/lib/marathon/rootfs
          type: DirectoryOrCreate
      - name: kernel
        hostPath:
          path: /var/lib/marathon/kernel
          type: DirectoryOrCreate
      - name: run
        hostPath:
          path: /run/firecracker
          type: DirectoryOrCreate
